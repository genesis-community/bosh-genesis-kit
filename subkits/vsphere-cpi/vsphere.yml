---
meta:
  vm_folder: (( concat params.env "/vms" ))
  template_folder: (( concat params.env "/templates" ))
  disk_path: (( concat params.env "/disks" ))

  joined_vsphere_ephemeral_datastores: (( join "|" params.vsphere_ephemeral_datastores ))
  vsphere_ephemeral_datastores: (( concat "^(" meta.joined_vsphere_ephemeral_datastores ")$" ))
  joined_vsphere_persistent_datastores: (( join "|" params.vsphere_persistent_datastores ))
  vsphere_persistent_datastores: (( concat "^(" meta.joined_vsphere_persistent_datastores ")$" ))

instance_groups:
- name: bosh
  jobs:
  - name: vsphere_cpi
    release: bosh-vsphere-cpi
  - name: registry
    release: bosh
  properties:
    registry:
      address: (( grab params.static_ip ))
      host:    (( grab params.static_ip ))
      db:      (( grab instance_groups.bosh.properties.postgres ))

      username: (( grab meta.bosh.registry.user ))
      password: (( grab meta.bosh.registry.pass ))
      port: 25777

    vcenter:
      user:           (( vault meta.vault "/vsphere:user" ))
      password:       (( vault meta.vault "/vsphere:password" ))
      host:           (( vault meta.vault "/vsphere:host" ))
      datacenters:
      - name: (( grab params.vsphere_datacenter ))
        vm_folder: (( grab meta.vm_folder ))
        template_folder: (( grab meta.template_folder ))
        disk_path: (( grab meta.disk_path ))
        datastore_pattern: (( grab meta.vsphere_ephemeral_datastores ))
        persistent_datastore_pattern: (( grab meta.vsphere_persistent_datastores ))
        clusters: (( grab params.vsphere_clusters ))

    director:
      cpi_job: vsphere_cpi

releases:
- name: bosh-vsphere-cpi
  version: 45
  sha1: b5f3c53c800d6c8a9182b263ec239a952f33ba67
  url: https://bosh.io/d/github.com/cloudfoundry-incubator/bosh-vsphere-cpi-release?v=45
